<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>下落彈珠檯</title>
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
  <style>
    body {
      background: #f4f4f4;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    #game {
      position: relative;
      width: 900px;
      height: 900px;
      border: 2px solid #333;
      background: white;
      overflow: hidden;
      margin-top: 1rem;
    }
    canvas {
      display: block;
    }
    #score-container, #money-container {
      position: absolute;
      top: 20px;
      font-size: 25px;
      z-index: 10;
    }
    #score-container {
      right: 20px;
    }
    #money-container {
      left: 20px;
    }
    input, button {
      margin: 0.5rem;
      padding: 0.5rem;
      font-size: 1rem;
    }
  </style>
  
</head>

  
  <script>
    let autoDropInterval = null;
    function toggleAutoDrop(button) {
      if (autoDropInterval) {
        clearInterval(autoDropInterval);
        autoDropInterval = null;
        button.textContent = "自動落珠";
      } else {
        autoDropInterval = setInterval(dropBall, 350);
        button.textContent = "停止落珠";
      }
    }
  </script>

$1
  <div style="display: flex; flex-direction: column; align-items: center;">
  <input id="bet" type="number" placeholder="下注金額" />
  <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
    <button onclick="dropBall()">開始遊戲</button>
    <button onclick="toggleAutoDrop(this)">自動落珠</button>
  </div>
</div>
  <div id="game">
    <div id="money-container">持有金額：<span id="money">5000</span></div>
    <div id="score-container">得分：<span id="score">0</span></div>
  </div>

  <script>
    const { Engine, Render, Runner, World, Bodies, Body, Events } = Matter;

    const engine = Engine.create();
    engine.gravity.y = 1;
    const world = engine.world;
    const game = document.getElementById("game");
    const render = Render.create({
      element: game,
      engine: engine,
      options: {
        width: 900,
        height: 900,
        wireframes: false,
        background: 'white'
      }
    });

    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);

    // 釘子生成
    const pegRows = 14;
    const pegCols = 17;
    const spacingX = 50;
    const spacingY = 50;
    for (let row = 0; row < pegRows; row++) {
      for (let col = 0; col < pegCols; col++) {
        const isOffset = row % 2 === 1;
        const x = col * spacingX + (isOffset ? spacingX / 2 : 0) + 50;
        const y = row * spacingY + 150;
        const peg = Bodies.circle(x, y, 5, {
          isStatic: true,
          render: { fillStyle: '#666' }
        });
        World.add(world, peg);
      }
    }

    // 地板與牆與得分區
    const scoreZones = [
      { x: 112.5, score: 0 },
      { x: 225, score: 1 },
      { x: 337.5, score: 3 },
      { x: 450, score: 5 },
      { x: 562.5, score: 10 },
      { x: 675, score: 30 },
      { x: 787.5, score: 50 },
      { x: 900, score: 100 }
    ];

    scoreZones.forEach(zone => {
      const wall = Bodies.rectangle(zone.x, 890, 5, 100, {
        isStatic: true,
        render: { fillStyle: '#ccc' }
      });
      World.add(world, wall);
    });

    Events.on(engine, 'collisionStart', function(event) {
      event.pairs.forEach(pair => {
        const { bodyA, bodyB } = pair;
        [bodyA, bodyB].forEach(body => {
          if (!body.isStatic && body.position.y > 850 && !body.scored) {
            body.scored = true;
            const scoreDisplay = document.getElementById("score");
            const moneyDisplay = document.getElementById("money");
            const bet = parseInt(document.getElementById("bet").value) || 0;
            const x = body.position.x;
            const zoneIndex = Math.floor(x / 112.5);
            const zone = scoreZones[Math.min(zoneIndex, scoreZones.length - 1)];
            const result = zone.score;

            scoreDisplay.textContent = parseInt(scoreDisplay.textContent) + result;
            moneyDisplay.textContent = parseInt(moneyDisplay.textContent) + result * bet;

            const anim = document.createElement("div");
            anim.className = "score-animation";
            anim.textContent = `+${result}`;
            Object.assign(anim.style, {
              position: 'absolute',
              top: '860px',
              left: '50%',
              transform: 'translateX(-50%)',
              fontSize: '2rem',
              color: 'green',
              opacity: '1',
              transition: 'transform 1s ease, opacity 1s ease'
            });
            game.appendChild(anim);

            const scoreRect = scoreDisplay.getBoundingClientRect();
            const gameRect = game.getBoundingClientRect();
            const offsetX = scoreRect.left - gameRect.left;
            const offsetY = scoreRect.top - gameRect.top;
            void anim.offsetWidth;
            anim.style.transform = `translate(${offsetX - 20}px, ${offsetY - 860}px)`;
            anim.style.opacity = '0';

            setTimeout(() => {
              anim.remove();
              World.remove(world, body);
            }, 300);
          }
        });
      });
    });

    const walls = [
      Bodies.rectangle(450, 0, 900, 10, { isStatic: true }),
      Bodies.rectangle(450, 900, 900, 10, { isStatic: true }),
      Bodies.rectangle(0, 450, 10, 900, { isStatic: true }),
      Bodies.rectangle(900, 450, 10, 900, { isStatic: true })
    ];
    World.add(world, walls);

    function dropBall() {
      const scoreDisplay = document.getElementById("score");
      const moneyDisplay = document.getElementById("money");
      const betInput = document.getElementById("bet");
      const bet = parseInt(betInput.value) || 0;
      let currentMoney = parseInt(moneyDisplay.textContent);

      if (bet <= 0 || bet > currentMoney) {
        alert("請輸入有效的下注金額，且不得超過持有金額。");
        return;
      }

      moneyDisplay.textContent = currentMoney - bet;

      const ball = Bodies.circle(450, 50, 10, {
        restitution: 0.6,
        render: { fillStyle: 'crimson' }
      });
      World.add(world, ball);
    }
  </script>
</body>
</html>
